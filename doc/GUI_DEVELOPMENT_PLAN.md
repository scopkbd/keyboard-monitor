# GUI版開発計画書

## 概要

キーボードモニターのGUI版開発の詳細計画書です。フェーズ1のコンソール版機能をベースに、**統合分析画面を中心とした**視覚的で使いやすいデスクトップアプリケーションを開発します。

## 開発コンセプト

### 🎯 中核機能：統合分析画面
本GUI版の中心となる「統合分析画面」は、以下の特徴を持ちます：

1. **実データ活用**: preceded_byフィールドを活用したリアルなシーケンス分析
2. **3列レイアウト**: 直前キー | メインキー | 直後キー の直感的な表示
3. **カードベース**: 情報を整理したカード形式での表示
4. **実装可能性**: 現在のデータ構造で確実に実装可能な機能に限定

## 技術仕様

### 開発環境
- **言語**: Python 3.8+
- **GUIフレームワーク**: CustomTkinter
- **テーマ**: Dark/Light モード対応
- **データ分析**: 既存のkeyboard_log.jsonを直接活用

### アーキテクチャ（統合分析画面中心）
```text
├── gui/
│   ├── main_window.py          # メインアプリケーション
│   ├── components/
│   │   ├── dashboard.py        # 基本ダッシュボード
│   │   ├── settings_panel.py   # 設定パネル
│   │   └── analytics/          # 🎯 統合分析画面（メイン機能）
│   │       ├── analytics_page.py           # 分析画面メインページ
│   │       ├── basic_stats_card.py         # 基本統計カード
│   │       ├── key_frequency_card.py       # 上位キー分析カード
│   │       ├── modifier_analysis_card.py   # モディファイア詳細カード
│   │       ├── integrated_sequence_card.py # 統合シーケンス分析カード
│   │       └── data_analyzer.py            # データ分析ロジック
│   ├── styles/
│   │   └── themes.py          # カラーテーマ定義
│   └── analytics_manager.py   # 分析データ管理
```

### データ活用戦略
現在のkeyboard_log.jsonの構造を最大限活用：
```json
{
  "total_statistics": {
    "total_keystrokes": 1041,
    "first_record_date": "2025-06-11",
    "last_record_date": "2025-06-15"
  },
  "key_statistics": {
    "72": {
      "key_name": "H",
      "count": 40,
      "modifier_combinations": {
        "none": {
          "count": 38,
          "preceded_by": { "69": 4, "84": 2, ... }  // 🎯 これを活用
        }
      }
    }
  }
}
```

## Phase 1: 基本GUIフレームワーク（✅ 完成済み）

### 完成済み機能
- [x] CustomTkinter セットアップ
- [x] メインウィンドウの設計・実装
- [x] 基本レイアウト（ダッシュボード、設定）
- [x] テーマシステム（Dark/Light）
- [x] キーボード記録の開始/停止UI
- [x] リアルタイム統計表示パネル
- [x] 基本統計情報の表示

## Phase 2: 統合分析画面の実装（🎯 メイン開発フェーズ）

### 2.1 データ分析ロジックの実装

#### 目標
現在のkeyboard_log.jsonから統合分析に必要なデータを抽出・加工する

#### 実装項目
1. **data_analyzer.py**: 分析データ処理の中核
   ```python
   def calculate_basic_stats(data)                    # 基本統計計算
   def analyze_key_frequency(data)                    # キー頻度分析
   def analyze_modifier_usage(data)                   # モディファイア分析
   def create_integrated_sequence_analysis(data)      # 統合シーケンス分析
   def get_top_predecessors(key_code, top_n=3)        # 直前キー分析
   def get_top_successors(key_code, top_n=3)          # 直後キー分析
   ```

2. **キーコード→キー名変換**: 特殊キー対応
3. **エラーハンドリング**: データ不整合時の適切な処理

### 2.2 統合分析画面レイアウトの実装

#### 目標
4つのカードで構成される統合分析画面を実装

#### レイアウト設計（✅ 実装完了）
```text
┌─────────────────────────────────────────────────────────────┐
│ 📈 キーボード使用統計                                        │
├─────────────────────────────────────────────────────────────┤
│ [統計更新] [データエクスポート]                              │
├─────────────────────────────────────────────────────────────┤
│ キー入力 1,175回    2025-06-11~2025-06-15                   │
├─────────────────────────────────────────────────────────────┤
│ ┌─上位キー分析カード────────┐ ┌─モディファイア詳細カード──┐ │
│ │順位 キー    回数    頻度  │ │┌Shift─┐┌Ctrl──┐┌Alt───┐┌Super─┐│ │
│ │ 1.  LEFT_S  99回   8.4%  │ ││1.LS  ││1.LC  ││1.I   ││1.LS  ││ │
│ │ 2.  S       98回   8.3%  │ ││ (13) ││ (9)  ││ (1)  ││ (99) ││ │
│ │ 3.  Enter   96回   8.2%  │ ││2.O   ││2.RC  ││2.LA  ││2.E   ││ │
│ │ 4.  D       84回   7.1%  │ ││ (5)  ││ (3)  ││ (1)  ││ (4)  ││ │
│ │ 5.  BS      82回   7.0%  │ ││3.Sp  ││3.Sp  ││      ││3.D   ││ │
│ │ 6.  ...                  │ ││ (4)  ││ (1)  ││      ││ (4)  ││ │
│ │                          │ ││4.I   ││      ││      ││4.R   ││ │
│ │                          │ ││ (3)  ││      ││      ││ (3)  ││ │
│ │                          │ ││5.H   ││      ││      ││5.I   ││ │
│ │                          │ ││ (2)  ││      ││      ││ (2)  ││ │
│ │                          │ │└─────┘└─────┘└─────┘└─────┘│ │
│ │                          │ │各修飾キーごとの上位5キー表示  │ │
│ └──────────────────────────┘ └──────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ ┌─統合シーケンス分析カード（キー中心の前後関係マップ）────┐ │
│ │⬅️ 直前キー        🎯 メインキー        ➡️ 直後キー     │ │
│ │                                                      │ │
│ │上位5キー（Left Super, S, Enter, D, Backspace）の     │ │
│ │3列レイアウトで前後関係を表示                           │ │
│ │                                                      │ │
│ │E→H: 4回  │  H (40回)  │  H→O: 15回                   │ │
│ │T→H: 2回  │            │  H→E: 8回                    │ │
│ │S→H: 1回  │            │  H→A: 5回                    │ │
│ └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 実装ファイル
1. **analytics_page.py**: メイン分析ページ（ステータスバー統計表示を含む）
2. **basic_stats_card.py**: 基本統計カード（※現在はメインレイアウトでは未使用）
3. **key_frequency_card.py**: 上位キー分析カード
4. **modifier_analysis_card.py**: モディファイア詳細カード
5. **integrated_sequence_card.py**: 統合シーケンス分析カード（3列レイアウト）

### 2.3 メインウィンドウへの統合

#### 目標
既存のメインウィンドウに統合分析画面を追加

#### 実装項目
1. **ナビゲーション追加**: 「📊 統合分析」メニュー項目
2. **画面切り替え**: ダッシュボード ↔ 統合分析画面
3. **データ連携**: リアルタイムデータ更新との連携
- [ ] 基本ウィンドウ構造
- [ ] ナビゲーションシステム
- [ ] テーマ切り替え機能
- [ ] 既存CLIとの統合

## Phase 2.2: コア機能GUI化

### 目標
既存のCLI機能をGUIで操作可能にする

### 実装項目
#### 1. 記録制御UI
- **開始/停止ボタン**: 大きく分かりやすい制御
- **状態表示**: 記録中/停止中の視覚的表示
- **セッション情報**: 開始時刻、経過時間、キーストローク数

#### 2. システムトレイ統合
- **最小化時**: システムトレイに格納
- **クイックメニュー**: 右クリックで基本操作
- **通知**: 重要なイベントの通知

### Phase 2.2 成果物
- [ ] 記録制御GUI
- [ ] システムトレイ機能
- [ ] 基本通知システム

## Phase 2.3: 高度な視覚化

### 目標
データを美しく分かりやすいグラフで表示する

### 実装項目

#### 1. キーストローク頻度グラフ
- **棒グラフ**: 使用頻度ランキング
## Phase 3: 将来の拡張機能（オプション）

### 3.1 高度な視覚化（Phase 2.3）
**注意**: 現在は実装対象外。統合分析画面完成後に検討。

- **グラフ表示**: matplotlib統合による棒グラフ・円グラフ
- **ヒートマップ**: キーボード配列での使用頻度視覚化
- **時系列分析**: 使用パターンの時間推移

### 3.2 詳細設定とカスタマイズ（Phase 2.4）
**注意**: 基本機能完成後に実装。

- **自動起動**: Windows起動時の自動開始
- **プロファイル管理**: 複数の設定プロファイル
- **通知機能**: カスタムアラート・レポート

### 3.3 パフォーマンス最適化（Phase 2.5）
**注意**: アプリケーション完成後に実施。

- **メモリ使用量最適化**: 長時間動作対応
- **起動時間短縮**: 効率的な初期化
- **配布準備**: インストーラー作成

## 開発スケジュール

### 推定期間（統合分析画面中心）✅ 完成済み
- **Phase 1**: ✅ 完成済み（基本GUIフレームワーク）
- **Phase 2.1**: ✅ 完成済み（データ分析ロジック）
- **Phase 2.2**: ✅ 完成済み（統合分析画面レイアウト）
- **Phase 2.3**: ✅ 完成済み（メインウィンドウ統合）

**統合分析画面完成**: ✅ 完了（モディファイア詳細カードの4列グリッド実装完了）

### 実装ステータス
🎯 **モディファイア詳細カード**: ✅ 4列グリッド形式で実装完了
- Shift, Ctrl, Alt, Superの修飾キーが水平に4列配置
- 各修飾キーごとの上位5キーランキング表示
- 色分け（修飾キー別）とランキング色コーディング
- データ不足時の適切なフォールバック表示

### 開発優先度
1. 🎯 **最優先**: Phase 2（統合分析画面）
2. ⭐ **次期**: Phase 3.1（高度な視覚化）
3. 📋 **将来**: Phase 3.2（詳細設定）
4. 🔧 **最終**: Phase 3.3（最適化・配布）

## 品質保証

### テスト戦略
- **データ分析テスト**: 既存のkeyboard_log.jsonでの動作確認
- **UI操作テスト**: 各カードの表示・更新動作
- **統合テスト**: メインウィンドウとの連携確認
- **エラーハンドリング**: データ不整合時の適切な処理

### 成功指標
- [x] 既存CLI機能の基本GUI化
- [x] 統合分析画面の完全実装
- [x] preceded_byデータの完全活用
- [x] 直感的なシーケンス分析の提供
- [x] エラーなしでの安定動作
- [x] モディファイア詳細カードの4列グリッド実装
- [x] 各修飾キー別上位キーランキング表示
- [x] カラーコーディングと視覚的改善

## リソース要件

### 追加依存関係（最小限）
- **CustomTkinter**: GUI基盤（既存）
- **既存データ**: keyboard_log.json活用
- **既存分析**: src/analyzer.py等の活用

### 開発リソース
- **新規実装**: analytics/配下のコンポーネントのみ
- **既存活用**: メインウィンドウ、設定、テーマ等は既存のまま
- **データ構造**: 現在のJSONフォーマットをそのまま活用

---

## 📊 統合分析画面の詳細仕様

### カード構成（3カード + ステータスバー）- 現在の実装状況
1. **ステータスバー統計情報**: 総キーストローク数と記録期間をステータスバーに表示（例：「キー入力 1,175回    2025-06-11~2025-06-15」）
2. **上位キー分析カード**: テーブル形式の使用頻度ランキング（順位、キー、回数、頻度のカラム構造）
3. **モディファイア詳細カード**: 4列グリッド形式（Shift, Ctrl, Alt, Superが横並び、各修飾キーごとの上位5キーランキング）
4. **統合シーケンス分析カード**: 3列レイアウト（直前|メイン|直後）での前後関係表示

**注意**: 基本統計カード（basic_stats_card.py）は実装されていますが、現在のメインレイアウトではステータスバー表示に統合されています。

### データ活用方法
```python
# preceded_by活用例
"preceded_by": { "69": 4, "84": 2, "83": 1 }
# → E→H: 4回, T→H: 2回, S→H: 1回 として表示
```

### UI特徴
- **カードベース**: 情報整理された見やすいレイアウト
- **3列構成**: キー中心の前後関係マップ
- **実データ活用**: 期間選択等の未実装機能は除外
- **エラー耐性**: データ不整合時の適切なフォールバック

#### 2. ステータスバー統計情報（✅ 実装完了）
- **総キーストローク数**: 記録開始からの累計（1,175回）
- **記録期間**: first_record_date ～ last_record_date（2025-06-11~2025-06-15）
- **レイアウト**: ステータスバーに「キー入力 xxxx回    yyyy-mm-dd~yyyy-mm-dd」形式で表示

#### 3. 上位キー分析カード（✅ 実装完了）
- **テーブル形式**: 統一されたカラム構造（順位、キー、回数、頻度）
- **使用頻度ランキング**: count値による降順ソート（Left Super, S, Enter, D, Backspace等）
- **使用率表示**: 各キーの全体に対する割合表示とプログレスバー
- **スクロール表示**: 全キーのランキング表示に対応

#### 4. モディファイア詳細カード（✅ 実装完了）
- **4列グリッド形式**: Shift, Ctrl, Alt, Superが横に4つ並ぶレイアウト
- **各修飾キーカラム**: 個別の色分け（Shift: 緑、Ctrl: 青、Alt: オレンジ、Super: 紫）
- **上位キーランキング**: 各修飾キーごとの上位5個のキーを表示
  - Shift: Left Shift(13), O(5), Space(4), I(3), H(2)
  - Ctrl: Left Ctrl(9), Right Ctrl(3), Space(1)
  - Alt: I(1), Left Alt(1)
  - Super: Left Super(99), E(4), D(4), R(3), I(2)
- **コンパクト表示**: 順位、キー名、回数を簡潔に表示
- **カラーコーディング**: ランキング順位に応じた色の濃淡表示
- **cross-platform対応**: Win→Super統一済み

#### 5. 統合シーケンス分析カード（✅ 実装完了）
- **3列レイアウト**: 直前キー | メインキー | 直後キー
- **上位5キー対象**: 使用頻度の高いキー（Left Super, S, Enter, D, Backspace）に絞った分析
- **前後関係マップ**: 各キーへの「入力経路」と「出力先」を可視化
- **動的更新**: データ変更時の自動反映

#### 6. データ分析ロジック（✅ 実装完了）
```python
# 主要な分析関数（実装済み）
def calculate_basic_stats(data)                    # 基本統計計算
def analyze_key_frequency(data)                    # キー頻度分析
def analyze_modifier_usage(data)                   # モディファイア使用分析
def analyze_modifier_key_rankings(data)            # 各修飾キーごとの上位キーランキング
def create_integrated_sequence_analysis(data)      # 統合シーケンス分析
def get_top_predecessors(key_code, top_n=3)        # 直前キー分析
def get_top_successors(key_code, top_n=3)          # 直後キー分析
```

#### 7. UIコンポーネント設計（✅ 実装完了）
- **カードベースレイアウト**: 情報を整理したカード形式
- **レスポンシブデザイン**: ウィンドウサイズに応じた調整
- **テーマ対応**: ダーク/ライトモード完全対応
- **エクスポート機能**: JSON/CSV形式でのデータ出力機能

## 📋 現在のステータス: 統合分析画面完成（4列グリッド実装完了）

### ✅ 完了済み機能
- 3カード構成の統合分析画面（上位キー、モディファイア詳細、統合シーケンス）+ ステータスバー統計表示
- **モディファイア詳細カード**: 4列グリッド形式（Shift, Ctrl, Alt, Super横並び）
- **基本統計情報**: ステータスバーでのコンパクト表示（「キー入力 xxxx回    yyyy-mm-dd~yyyy-mm-dd」形式）
- 各修飾キーごとの上位5キーランキング表示
- カラーコーディング（修飾キー別色分け + ランキング色の濃淡）
- 実データ活用（keyboard_log.json, preceded_byフィールド活用）
- cross-platform対応（Win→Super統一）
- 動的データ更新・エクスポート機能
- エラーハンドリング（データ不足時の適切なフォールバック）

### 🎯 実装完了の詳細
**モディファイア詳細カード**の4列グリッド実装により、以下が達成されました：
1. **統一されたカード構造**: 上位キー分析カードと同様の視覚的一貫性
2. **効率的な情報表示**: 水平4列で修飾キー情報を最大限活用
3. **直感的なレイアウト**: Shift, Ctrl, Alt, Superが一目で比較可能
4. **視覚的改善**: ランキング順位に応じた色の濃淡で情報を分かりやすく表示

### 🔧 今後の改善可能性（オプション）
以下の追加改善案を今後検討可能：
1. **基本統計カード1行表示**: 更なる画面効率化
2. **左右分割レイアウト**: 上位キー分析（左）+ モディファイア詳細（右）
3. **統合シーケンス分析**: 全幅表示の維持・強化

---

### Phase 2.6 実装ファイル（✅ 完成済み）
- `gui/components/analytics/analytics_page.py` - メイン分析ページ
- `gui/components/analytics/basic_stats_card.py` - 基本統計カード
- `gui/components/analytics/key_frequency_card.py` - 上位キー分析カード
- `gui/components/analytics/modifier_analysis_card.py` - モディファイア詳細カード
- `gui/components/analytics/integrated_sequence_card.py` - 統合シーケンス分析カード
- `gui/components/analytics/data_analyzer.py` - データ分析ロジック

### Phase 2.6 成果物（✅ 完成済み）
- [x] ステータスバー統計表示機能（コンパクトな基本統計表示）
- [x] キー使用頻度分析
- [x] モディファイア詳細分析（4列グリッド実装完了）
- [x] 各修飾キーごとの上位キーランキング
- [x] カラーコーディング（修飾キー別 + ランキング色濃淡）
- [x] 統合シーケンス分析
- [x] データエクスポート機能
- [x] メインウィンドウへの統合
- [x] エラーハンドリング・フォールバック処理
